From 4c2e24e893ea3516fe4ba79d8d866c7eda6810ab Mon Sep 17 00:00:00 2001
From: Andreas Schultz <andreas.schultz@travelping.com>
Date: Tue, 27 Apr 2021 18:51:41 +0200
Subject: [PATCH 2/4] diameter: fix set unodered flag in client (connect) mode

The semantics of switching a SCTP from ordered to unorderd are not
documented anywhere. The code as using assoc_id == 0, which mean
"all future associations". Adding a stream to the current association
is by strict reading not a new association, but an extension to the
current existing one. None the less, this work on the server
(listening) side.

It does not work on the client (connecting) side, at least on recent
Linux kernels. Using a value of 1 (SCTP_CURRENT_ASSOC) makes it work
on both sides.
---
 lib/diameter/src/transport/diameter_sctp.erl | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/lib/diameter/src/transport/diameter_sctp.erl b/lib/diameter/src/transport/diameter_sctp.erl
index b6a25a9a63..ed5832cde4 100644
--- a/lib/diameter/src/transport/diameter_sctp.erl
+++ b/lib/diameter/src/transport/diameter_sctp.erl
@@ -813,9 +813,10 @@ recv(#transport{rotate = B} = S)
 recv(#transport{rotate = 0,
                 streams = {_,OS},
                 socket = Sock,
+                assoc_id = Id,
                 unordered = B}
      = S) ->
-    ok = unordered(Sock, OS, B),
+    ok = unordered(Sock, Id, OS, B),
     S#transport{rotate = 1 < OS};
 
 recv(#transport{rotate = N} = S) ->
@@ -823,13 +824,13 @@ recv(#transport{rotate = N} = S) ->
 
 %% unordered/3
 
-unordered(Sock, OS, B)
+unordered(Sock, Id, OS, B)
   when B;
        is_integer(B), OS =< B ->
     inet:setopts(Sock, [{sctp_default_send_param,
-                         #sctp_sndrcvinfo{flags = [unordered]}}]);
+                         #sctp_sndrcvinfo{flags = [unordered], assoc_id = Id}}]);
 
-unordered(_, OS, B)
+unordered(_, _, OS, B)
   when not B;
        is_integer(B), B < OS ->
     ok.
-- 
2.30.2

